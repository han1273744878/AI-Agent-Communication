# Agent Communication RPC Framework

基于 C++ 和 gRPC 的高性能 AI Agent 通信框架，支持多 Agent 协作、MCP 工具调用和 RAG 智能工具选择。

## 目录

- [项目概述](#项目概述)
- [系统架构](#系统架构)
- [环境要求](#环境要求)
- [编译构建](#编译构建)
- [快速启动](#快速启动)
- [完整部署指南](#完整部署指南)
- [功能模块](#功能模块)
- [配置说明](#配置说明)
- [API 参考](#api-参考)
- [测试](#测试)
- [常见问题](#常见问题)

---

## 项目概述

Agent Communication RPC Framework 是一个专为多 Agent 协作场景设计的通信框架。

### 核心能力

| 能力 | 说明 |
|------|------|
| gRPC 通信 | 基于 gRPC 的高性能远程过程调用 |
| A2A 协议 | Agent-to-Agent 通信协议支持 |
| MCP 集成 | Model Context Protocol 工具调用 |
| RAG-MCP | 基于检索增强生成的智能工具选择 |
| 服务发现 | 支持内存注册中心 |
| 多 Agent 协作 | Orchestrator 协调多个专业 Agent |

### 技术栈

- **语言**: C++17
- **RPC 框架**: gRPC + Protocol Buffers
- **HTTP 客户端**: libcurl
- **JSON 处理**: nlohmann/json, jsoncpp
- **测试框架**: Google Test + RapidCheck (属性测试)
- **向量化服务**: 阿里百炼 DashScope API
- **AI 模型**: 通义千问 (Qwen)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户应用层                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         RPC Client                                   │   │
│  │                    (build/client/rpc_client)                         │   │
│  └──────────────────────────────┬──────────────────────────────────────┘   │
└─────────────────────────────────┼───────────────────────────────────────────┘
                                  │ gRPC/Protobuf
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              RPC 服务层                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         RPC Server                                   │   │
│  │                    (build/server/rpc_server)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │AIQueryService│  │ A2A Adapter │  │HealthService│                  │   │
│  │  └──────┬──────┘  └──────┬──────┘  └─────────────┘                  │   │
│  └─────────┼────────────────┼──────────────────────────────────────────┘   │
└────────────┼────────────────┼───────────────────────────────────────────────┘
             │                │ A2A Protocol (HTTP/JSON-RPC)
             │                ▼
┌────────────┼────────────────────────────────────────────────────────────────┐
│            │           Agent 协调层                                          │
│  ┌─────────┴───────────────────────────────────────────────────────────┐   │
│  │                      Orchestrator Agent                              │   │
│  │                 (ai_orchestrator, 端口 5000)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ 意图识别     │  │ Agent 路由  │  │ MCP 工具    │                  │   │
│  │  │ (Qwen API)  │  │             │  │             │                  │   │
│  │  └─────────────┘  └──────┬──────┘  └─────────────┘                  │   │
│  └──────────────────────────┼──────────────────────────────────────────┘   │
│                             │                                               │
│            ┌────────────────┼────────────────┐                             │
│            ▼                ▼                ▼                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐              │
│  │   Math Agent    │ │   Code Agent    │ │   Other Agent   │              │
│  │ (ai_math_agent) │ │    (可扩展)      │ │    (可扩展)      │              │
│  │   端口 5001     │ │                 │ │                 │              │
│  │  + MCP Tools    │ │  + MCP Tools    │ │  + MCP Tools    │              │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘              │
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                      Registry Server                                 │  │
│  │                   (ai_registry_server, 端口 8500)                    │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
```

### 数据流向

```
1. 用户输入 "1+7"
2. rpc_client → gRPC → rpc_server (端口 50051)
3. rpc_server → A2A Adapter → Orchestrator (端口 5000)
4. Orchestrator 识别意图为 "math"
5. Orchestrator → Math Agent (端口 5001)
6. Math Agent 调用 MCP calculator 工具
7. 返回结果 "1+7 = 8"
8. 响应原路返回给用户
```

---

## 环境要求

### 系统要求

| 要求 | 版本 |
|------|------|
| 操作系统 | Linux (Ubuntu 20.04+) |
| CMake | 3.15+ |
| C++ 编译器 | GCC 9+ (支持 C++17) |
| Redis | 6.0+ (任务状态存储) |
| grpc | 1.51.1 |

### 安装依赖

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y \
    cmake \
    build-essential \
    pkg-config \
    libgrpc++-dev \
    libprotobuf-dev \
    protobuf-compiler \
    protobuf-compiler-grpc \
    libcurl4-openssl-dev \
    libjsoncpp-dev \
    uuid-dev \
    libgtest-dev \
    libhiredis-dev \
    redis-server \
    nlohmann-json3-dev
```

### 必需的 API Key

| API Key | 用途 | 获取方式 |
|---------|------|----------|
| QWEN_API_KEY | 通义千问 AI 模型，用于对话和意图识别 | [阿里云百炼](https://bailian.console.aliyun.com/) |
| DASHSCOPE_API_KEY | RAG 向量化服务，用于智能工具选择 | [阿里云 DashScope](https://dashscope.console.aliyun.com/) |

> **注意**: 两个 API Key 都是完整功能所必需的。DASHSCOPE_API_KEY 用于 RAG-MCP 的工具向量化和检索功能。

---
